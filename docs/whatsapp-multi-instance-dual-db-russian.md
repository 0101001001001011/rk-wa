# Поддержка двух баз данных (MongoDB и SQLite)

API для мульти-инстансов WhatsApp поддерживает два типа баз данных: MongoDB и SQLite. Это позволяет выбрать оптимальное решение на основе ваших потребностей и ресурсов.

## Сравнение баз данных

| Функция | MongoDB | SQLite |
|---------|---------|--------|
| Производительность с большими объемами данных | Высокая | Средняя |
| Требования к ресурсам | Высокие | Низкие |
| Распределенное развертывание | Да | Нет |
| Конфигурация | Сложная | Простая |
| Резервное копирование | Простое (один файл) | Простое (один файл) |
| Нагрузка на сервер | Средняя | Низкая |
| Горизонтальное масштабирование | Да | Нет |

## Конфигурация

### 1. Переменные окружения

Для поддержки обеих баз данных в файле `.env` используются следующие переменные:

```
# Выбор провайдера базы данных: mongodb или sqlite
DATABASE_PROVIDER=mongodb

# URL для MongoDB
DATABASE_URL="mongodb://username:password@localhost:27017/whatsapp-api?authSource=admin"

# URL для SQLite (путь к файлу)
SQLITE_DATABASE_URL="file:./data/whatsapp-api.db"
```

Примеры этих конфигураций можно увидеть в файлах `.env` и `.env.docker`, предоставленных с проектом.

### 2. Инициализация базы данных

База данных инициализируется автоматически при запуске приложения. Процесс инициализации управляется классом `DBConnector`, который выполняет:

- Создание директории для базы данных (для SQLite)
- Резервное копирование существующих файлов базы данных (для SQLite)
- Запуск миграций Prisma
- Создание начального пользователя-администратора

Вы также можете вручную инициализировать базу данных, запустив приложение с установленной переменной окружения DATABASE_PROVIDER.

## Переключение между базами данных

### Метод 1: Через API

API предоставляет конечные точки для просмотра и переключения текущего провайдера:

```
GET /api/db/status - Возвращает текущий провайдер базы данных
POST /api/db/switch - Переключает провайдер (требуется "provider": "mongodb" или "sqlite")
```

Пример запроса для переключения на SQLite:

```bash
curl -X POST http://localhost:3000/api/db/switch \
  -H "Content-Type: application/json" \
  -d '{"provider": "sqlite"}'
```

API выполнит:
1. Отключение от текущей базы данных
2. Переключение на нового провайдера
3. Инициализацию соединения с новой базой данных
4. Обновление переменной окружения для последующих перезапусков

### Метод 2: Путем изменения файла .env

Вы можете вручную изменить значение `DATABASE_PROVIDER` в файле `.env`, а затем перезапустить сервер.

## Работа с данными JSON

Поскольку SQLite не поддерживает нативное хранение JSON, приложение автоматически обрабатывает конвертацию JSON данных:

1. Класс `DBConnector` предоставляет метод `handleJsonData()`, который сериализует и десериализует JSON данные
2. При хранении JSON в SQLite, он конвертируется в строковое представление
3. При извлечении JSON из SQLite, он парсится обратно в объекты
4. Это обрабатывается прозрачно в сервисах, таких как `instance.service.js` и других

Это влияет на несколько типов данных:
- Заголовки веб-хуков
- Метаданные сообщений
- Детали журнала активности

## Особенности использования

### MongoDB

- Лучше подходит для высоконагруженных систем с большим количеством пользователей
- Рекомендуется для производственных сред с большими объемами данных
- Требует установки и настройки сервера MongoDB
- Поддерживает нативное хранение данных JSON

### SQLite

- Идеально подходит для демонстраций, разработки и тестирования
- Хорошо работает на машинах с ограниченными ресурсами
- Не требует дополнительного программного обеспечения – вся база данных в одном файле
- Все данные хранятся локально, упрощая резервное копирование
- Имеет ограничения на параллельные запросы и большие объемы данных

## Резервное копирование

### MongoDB

Для резервного копирования MongoDB используйте стандартные инструменты:

```bash
# Создание резервной копии
mongodump --uri="mongodb://username:password@localhost:27017/whatsapp-api" --out=./backup

# Восстановление
mongorestore --uri="mongodb://username:password@localhost:27017/whatsapp-api" ./backup
```

### SQLite

Для SQLite резервное копирование выполняется автоматически во время инициализации, создавая файлы резервных копий с метками времени. Вы также можете вручную скопировать файл базы данных:

```bash
# Предполагая, что путь к файлу базы данных - ./data/whatsapp-api.db
cp ./data/whatsapp-api.db ./backup/whatsapp-api-$(date +%Y%m%d).db
```

## Поддержка Docker

Проект включает поддержку Docker для обоих типов баз данных. При использовании Docker:

1. Вы можете указать провайдер базы данных в файле docker-compose.yml
2. Контейнер автоматически инициализирует выбранную базу данных
3. Данные SQLite хранятся в постоянном томе

Пример из docker-compose.yml:
```yaml
environment:
  - DATABASE_PROVIDER=sqlite
  - DATABASE_URL=mongodb://whatsapp:whatsapp-password@mongodb:27017/whatsapp-api?authSource=admin
  - SQLITE_DATABASE_URL=file:/usr/src/app/data/whatsapp-api.db
```

## Рекомендации

1. **Разработка и тестирование**: SQLite лучше из-за простоты настройки
2. **Производство с низкой нагрузкой**: SQLite может быть достаточным для небольших установок
3. **Производство с высокой нагрузкой**: MongoDB обеспечит лучшую производительность
4. **Развертывание Docker**: SQLite проще для контейнеризации, так как не требует отдельного сервиса базы данных

## Устранение неполадок

### Проблемы SQLite

- **Ошибка "База данных заблокирована"**: Возникает при параллельном доступе. SQLite поддерживает только один процесс записи.
- **Проблемы с правами доступа к файлам**: Убедитесь, что процесс имеет права на чтение/запись файла базы данных.
- **Размер файла**: SQLite может замедлиться, когда файл базы данных превышает 1 ГБ. Регулярно архивируйте старые данные.

### Проблемы MongoDB

- **Ошибки подключения**: Проверьте, что сервер MongoDB запущен и доступен по указанному URL.
- **Аутентификация**: Убедитесь, что учетные данные в DATABASE_URL верны.
- **Ошибки индексирования**: Создайте индексы для лучшей производительности с большими объемами данных.

## Мониторинг

Конечная точка API `/health` включает информацию о текущем провайдере базы данных и состоянии подключения.

Пример ответа:
```json
{
  "status": "ok",
  "timestamp": "2023-01-01T12:00:00.000Z",
  "dbProvider": "sqlite"
}
```