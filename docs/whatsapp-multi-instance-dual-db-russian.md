# Двойная поддержка баз данных (MongoDB и SQLite)

WhatsApp Multi-Instance API теперь поддерживает две базы данных: MongoDB и SQLite. Это позволяет вам выбирать оптимальное решение в зависимости от ваших потребностей и ресурсов.

## Сравнение баз данных

| Функция | MongoDB | SQLite |
|---------|---------|--------|
| Производительность на больших объемах данных | Высокая | Средняя |
| Требования к ресурсам | Высокие | Низкие |
| Распределенное развертывание | Да | Нет |
| Настройка | Сложная | Простая |
| Резервное копирование | Сложное | Простое (один файл) |
| Нагрузка на сервер | Средняя | Низкая |
| Горизонтальное масштабирование | Да | Нет |

## Настройка

### 1. Переменные окружения

Для поддержки двух баз данных, в `.env` файле необходимо добавить следующие переменные:

```
# Выбор провайдера базы данных: mongodb или sqlite
DATABASE_PROVIDER=mongodb

# URL для MongoDB
DATABASE_URL="mongodb://username:password@localhost:27017/whatsapp-api?authSource=admin"

# URL для SQLite (путь к файлу)
SQLITE_DATABASE_URL="file:./data/whatsapp-api.db"
```

### 2. Инициализация баз данных

Для инициализации обеих баз данных выполните следующие команды:

```bash
# Генерация клиентов Prisma для обоих типов баз данных
npm run prisma:generate:all

# Инициализация баз данных и создание администратора
node scripts/init-databases.js
```

Скрипт `init-databases.js` создаст необходимые таблицы/коллекции в обеих базах данных и создаст первоначального пользователя-администратора.

## Переключение между базами данных

### Способ 1: Через API

API предоставляет эндпоинты для просмотра текущего провайдера и переключения между ними:

```
GET /api/db/status - Возвращает текущий провайдер баз данных
POST /api/db/switch - Переключает провайдер (требуется параметр "provider": "mongodb" или "sqlite")
```

Пример запроса для переключения на SQLite:

```bash
curl -X POST http://localhost:3000/api/db/switch \
  -H "Content-Type: application/json" \
  -d '{"provider": "sqlite"}'
```

### Способ 2: Изменение .env файла

Вы можете вручную изменить значение `DATABASE_PROVIDER` в файле `.env`, а затем перезапустить сервер.

### Способ 3: Утилита командной строки

Для удобства переключения предоставляется специальная утилита:

```bash
node scripts/switch-database.js
```

Эта утилита интерактивно проведет вас через процесс переключения баз данных.

## Миграция данных между базами

Если у вас уже есть данные в одной из баз и вы хотите перенести их в другую, можете использовать скрипт миграции:

```bash
node scripts/migrate-database.js
```

Скрипт предоставляет интерактивный интерфейс, который позволяет:
1. Выбрать направление миграции (MongoDB → SQLite или SQLite → MongoDB)
2. Выбрать типы данных для миграции (пользователи, инстансы, сообщения и т.д.)
3. Установить лимиты для больших наборов данных (сообщения, логи активности)

## Особенности использования

### MongoDB

- Лучше подходит для высоконагруженных систем с большим количеством пользователей
- Рекомендуется для продакшн-сред с большим объемом данных
- Требует установки и настройки MongoDB сервера
- Поддерживает нативное хранение JSON-данных

### SQLite

- Идеально подходит для демонстраций, разработки и тестирования
- Отлично работает на машинах с ограниченными ресурсами
- Не требует дополнительного ПО – вся база данных в одном файле
- Все данные хранятся локально, что упрощает резервное копирование
- Имеет ограничения на параллельные запросы и больший объем данных

## Особенности работы с JSON-данными

Поскольку SQLite не поддерживает нативное хранение JSON, в процессе работы с ним:

1. JSON-данные автоматически сериализуются/десериализуются при записи/чтении
2. Некоторые операции фильтрации в SQLite могут работать медленнее, если они используют поля внутри JSON
3. Количество вложенных транзакций в SQLite ограничено

## Резервное копирование

### MongoDB

Для резервного копирования MongoDB используйте стандартные инструменты:

```bash
# Создание бэкапа
mongodump --uri="mongodb://username:password@localhost:27017/whatsapp-api" --out=./backup

# Восстановление
mongorestore --uri="mongodb://username:password@localhost:27017/whatsapp-api" ./backup
```

### SQLite

Для SQLite резервное копирование - это просто копирование файла базы данных:

```bash
# Предполагаем, что путь к файлу базы данных - ./data/whatsapp-api.db
cp ./data/whatsapp-api.db ./backup/whatsapp-api-$(date +%Y%m%d).db
```

## Рекомендации

1. **Разработка и тестирование**: SQLite подходит лучше из-за простоты настройки
2. **Продакшн с малой нагрузкой**: SQLite может быть достаточным для небольших инсталляций
3. **Продакшн с высокой нагрузкой**: MongoDB обеспечит лучшую производительность
4. **Docker-развертывание**: SQLite проще для контейнеризации, так как не требует отдельного сервиса базы данных

## Устранение неполадок

### Проблемы с SQLite

- **Ошибка "Database is locked"**: Возникает при одновременном доступе. SQLite поддерживает только один процесс записи.
- **Проблемы с правами доступа к файлу**: Убедитесь, что процесс имеет разрешения на чтение/запись в файл базы данных.
- **Размер файла**: SQLite может замедляться, когда файл базы данных превышает 1GB. Регулярно архивируйте старые данные.

### Проблемы с MongoDB

- **Ошибки соединения**: Проверьте, что MongoDB сервер запущен и доступен по указанному URL.
- **Аутентификация**: Убедитесь, что учетные данные в DATABASE_URL корректны.
- **Ошибки индексации**: При большом объеме данных создайте индексы для улучшения производительности.

## Мониторинг

Для наблюдения за работой баз данных используйте:

- **MongoDB**: MongoDB Compass или MongoDB Atlas для мониторинга
- **SQLite**: SQLite Browser для просмотра и редактирования данных

Эндпоинт `/health` API включает в себя информацию о текущем провайдере базы данных